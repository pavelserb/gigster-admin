# Система аналитики и отслеживания событий

## Обзор

Реализована полная система отслеживания событий для ивент-сайта с поддержкой всех основных рекламных платформ:

- **Google Analytics 4** - основная аналитика
- **Google Tag Manager** - управление тегами
- **Facebook Pixel** - ретаргетинг в Meta
- **TikTok Pixel** - реклама в TikTok
- **Кастомные теги** - дополнительные пиксели

## Структура файлов

```
js/
├── analytics.js      # Система отслеживания событий
├── pixels.js         # Загрузка пикселей
└── main.js           # Интеграция с основным кодом

admin/
├── js/
│   └── pixelManager.js  # Управление пикселями в админке
├── css/
│   └── admin.css        # Стили для интерфейса
└── server.js            # API для управления пикселями
```

## Отслеживаемые события

### 1. page_view
- **Описание:** Просмотр страницы
- **Параметры:** URL, referrer, UTM-параметры, язык
- **Платформы:** GA4, Meta, TikTok

### 2. ticket_click
- **Описание:** Клик по основной кнопке "Tickets"
- **Параметры:** Позиция (floating/секция), vendor_name
- **Платформы:** GA4 (select_item), Meta (Lead), TikTok (Lead)

### 3. vendor_click
- **Описание:** Клик по продавцу билетов
- **Параметры:** Название продавца, позиция
- **Платформы:** GA4 (select_item), Meta (Lead), TikTok (Lead)

### 4. ticket_category_click
- **Описание:** Клик по категории билетов
- **Параметры:** Название категории, цена, vendor_name
- **Платформы:** GA4 (select_item), Meta (Lead), TikTok (Lead)

### 5. section_view
- **Описание:** Просмотр секций страницы
- **Параметры:** Название секции
- **Платформы:** GA4 (view_item_list), Meta (ViewContent), TikTok (ViewContent)

### 6. update_interaction
- **Описание:** Взаимодействие с обновлениями
- **Параметры:** Действие (expand/filter), тип, заголовок
- **Платформы:** GA4 (view_item), Meta (ViewContent), TikTok (ViewContent)

### 7. artist_interaction
- **Описание:** Взаимодействие с артистами
- **Параметры:** Имя артиста, действие, позиция
- **Платформы:** GA4 (view_item), Meta (ViewContent), TikTok (ViewContent)

### 8. language_change
- **Описание:** Смена языка
- **Параметры:** Новый язык, предыдущий язык, источник
- **Платформы:** GA4 (custom_event)



### 10. user_interaction
- **Описание:** Универсальное событие взаимодействия пользователя
- **Параметры:** Элемент, текст, позиция, тип, платформа, медиа-тип
- **Платформы:** GA4, Meta, TikTok

## Настройка в админке

### Доступ к настройкам
1. Откройте админку: `http://localhost:3001/admin`
2. Войдите с учетными данными: `admin / admin123`
3. Перейдите на вкладку "Маркетинг"

### Настройка пикселей

#### Google Tag Manager
- **ID контейнера:** GTM-XXXXXXX
- **Источник:** Google Tag Manager → Администратор → Контейнеры

#### Google Analytics 4
- **ID измерения:** G-XXXXXXXXXX
- **Источник:** Google Analytics → Администратор → Потоки данных

#### Facebook Pixel
- **ID пикселя:** XXXXXXXXXX
- **Источник:** Facebook Business Manager → События → Пиксели

#### TikTok Pixel
- **ID пикселя:** XXXXXXXXXX
- **Источник:** TikTok Ads Manager → События → Пиксели

### Дополнительные настройки

#### Кастомные теги
- Добавляйте любые дополнительные пиксели
- Поддерживается HTML/JavaScript код
- Можно включать/выключать отдельно

#### Настройки
- **Respect cookie consent** - загружать пиксели только после согласия
- **Debug mode** - логирование в консоль браузера

## Использование

### Автоматическая загрузка
Пиксели загружаются автоматически при открытии страницы.

### Ручное управление
```javascript
// Принудительная загрузка пикселей
window.pixelLoader.forceLoad();

// Обновление настроек
window.pixelLoader.refreshSettings();
```

### Отслеживание событий
```javascript
// Отслеживание кастомного события
window.eventTracker.track('custom_event', {
  category: 'User Action',
  action: 'Button Click',
  label: 'Special Offer'
});
```

## API Endpoints

### GET /api/pixels
Получение конфигурации пикселей

### POST /api/pixels
Сохранение конфигурации пикселей

## Файлы конфигурации

### pixels.json
```json
{
  "gtm": {
    "id": "GTM-XXXXXXX",
    "enabled": true
  },
  "ga": {
    "id": "G-XXXXXXXXXX",
    "enabled": true
  },
  "fb": {
    "id": "XXXXXXXXXX",
    "enabled": true
  },
  "tt": {
    "id": "XXXXXXXXXX",
    "enabled": true
  },
  "custom": [
    {
      "name": "Custom Pixel",
      "code": "<script>...</script>",
      "enabled": true
    }
  ],
  "settings": {
    "respectConsent": true,
    "debugMode": false
  }
}
```

## Автоопределение языка

Система автоматически определяет язык браузера пользователя и применяет соответствующий язык на сайте:

- **Поддерживаемые языки:** EN, CS, UK
- **Приоритет:** Сохраненный язык → Язык браузера → EN (по умолчанию)
- **Отслеживание:** Смена языка отслеживается как событие

## Безопасность

- Проверка согласия на cookies
- Валидация конфигурации
- Безопасная загрузка скриптов
- Логирование ошибок

## Отладка

### Включение debug режима
1. В админке включите "Debug mode"
2. Откройте консоль браузера
3. Просматривайте логи загрузки пикселей

### Проверка событий
```javascript
// В консоли браузера
console.log('Event tracker:', window.eventTracker);
console.log('Pixel loader:', window.pixelLoader);
```

## Производительность

- Асинхронная загрузка пикселей
- Проверка на дублирование
- Оптимизированная отправка событий
- Lazy loading для тяжелых скриптов

## Совместимость

- **Браузеры:** Chrome, Firefox, Safari, Edge
- **Устройства:** Desktop, Tablet, Mobile
- **Платформы:** Все современные рекламные платформы

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера
2. Убедитесь в правильности ID пикселей
3. Проверьте настройки в админке
4. Обратитесь к документации платформ
