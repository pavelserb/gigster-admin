#!/bin/bash

# üöÄ ARTBAT Prague - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –∞–¥–º–∏–Ω–∫–∏ –Ω–∞ Railway
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –æ–Ω–ª–∞–π–Ω –∞–¥–º–∏–Ω–∫—É

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –∞–¥–º–∏–Ω–∫–∏ –Ω–∞ Railway..."
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js 16+ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Node.js
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 16 ]; then
    echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Node.js –≤–µ—Ä—Å–∏–∏ 16+. –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $(node -v)"
    exit 1
fi

echo "‚úÖ Node.js –≤–µ—Ä—Å–∏–∏ $(node -v) –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ npm
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ npm –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

echo "‚úÖ npm –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Railway CLI
if ! command -v railway &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Railway CLI..."
    npm install -g @railway/cli
else
    echo "‚úÖ Railway CLI —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Railway
echo "üîê –ü—Ä–æ–≤–µ—Ä—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Railway..."
if ! railway whoami &> /dev/null; then
    echo "‚ö†Ô∏è  –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ Railway –∞–∫–∫–∞—É–Ω—Ç"
    echo "üì± –û—Ç–∫—Ä–æ–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
    railway login
else
    echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Railway —É—Å–ø–µ—à–Ω–∞"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f .env ]; then
    echo "‚öôÔ∏è  –°–æ–∑–¥–∞—é —Ñ–∞–π–ª .env —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é..."
    cat > .env << EOF
# Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç PORT
PORT=3000

# FTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤–∞—à–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞
FTP_HOST=somos.ftp.tools
FTP_USER=somos_cursor
FTP_PASS=Pr6LUx9h45
FTP_PATH=/artbat-prague

# JWT —Å–µ–∫—Ä–µ—Ç (–ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!)
JWT_SECRET=artbat-prague-super-secret-key-$(date +%s)
EOF
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ò–∑–º–µ–Ω–∏—Ç–µ JWT_SECRET –≤ —Ñ–∞–π–ª–µ .env –Ω–∞ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á!"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ Railway
if [ ! -f railway.json ]; then
    echo "üöÇ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç Railway..."
    railway init
else
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç Railway —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é –∞–¥–º–∏–Ω–∫—É –ª–æ–∫–∞–ª—å–Ω–æ..."
echo "üì± –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏..."
timeout 5s npm start &
SERVER_PID=$!

sleep 6
if kill -0 $SERVER_PID 2>/dev/null; then
    kill $SERVER_PID
    echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"
    exit 1
fi

# –î–µ–ø–ª–æ–π –Ω–∞ Railway
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –¥–µ–ø–ª–æ–π –Ω–∞ Railway..."
railway up

echo ""
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "=================================================="
echo "üì± URL –∞–¥–º–∏–Ω–∫–∏: https://your-project.railway.app/admin"
echo "üîê –õ–æ–≥–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: admin / admin123"
echo "üìä –°—Ç–∞—Ç—É—Å API: https://your-project.railway.app/api/status"
echo ""
echo "‚ö†Ô∏è  –ù–ï –ó–ê–ë–£–î–¨–¢–ï:"
echo "   1. –ò–∑–º–µ–Ω–∏—Ç—å JWT_SECRET –≤ Railway Dashboard"
echo "   2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è FTP"
echo "   3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ server.js"
echo ""
echo "üìö –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README.md"
echo "üîß –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: railway dashboard"
