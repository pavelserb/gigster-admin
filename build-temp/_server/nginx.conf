# === ARTBAT Prague landing at /artbat-prague ===

# Сжатие
gzip on;
gzip_types text/plain text/css application/javascript application/json image/svg+xml;
gzip_min_length 1024;

# Включите Brotli, если модуль доступен
# brotli on;
# brotli_comp_level 5;
# brotli_types text/plain text/css application/javascript application/json image/svg+xml;

# Основные заголовки безопасности для всего префикса
location ^~ /artbat-prague/ {
  # HTML/JSON — без кэша
  location ~* \.(?:html?|json)$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    try_files $uri =404;
  }

  # CSS/JS/SVG — среднее кэширование
  location ~* \.(?:css|js|mjs|svg)$ {
    add_header Cache-Control "public, max-age=604800"; # 7 days
    try_files $uri =404;
  }

  # Медиа и шрифты — долгое кэширование
  location ~* \.(?:png|jpe?g|webp|gif|ico|mp4|webm|woff2?)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # CSP: разрешаем Google Fonts и встраивание OSM-карты
  add_header Content-Security-Policy "
    default-src 'self';
    img-src 'self' data:;
    media-src 'self' blob:;
    script-src 'self';
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    connect-src 'self';
    frame-ancestors 'self';
    frame-src https://www.openstreetmap.org https://www.google.com https://maps.google.com;
  " always;
}

# Явный запрет служебной директории проекта (на всякий случай)
location ^~ /artbat-prague/_server/ { return 404; }

# Отдача карты сайта и robots (если этот же сервер их обслуживает)
location = /meta/sitemap.xml { try_files $uri =404; }
location = /robots.txt       { try_files $uri =404; }
